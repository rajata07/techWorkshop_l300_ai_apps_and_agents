flowchart TD
%% ============================================================================
%% ZAVA AI PLATFORM - ENTERPRISE ARCHITECTURE
%% 7-Layer Architecture with Azure AI Services
%% ============================================================================

%% --- LAYER 1: USERS & CLIENTS ---
subgraph L1["ğŸ§‘ Layer 1: Users & Clients"]
  direction TB
  cu["ğŸ‘¤ Customer Web App<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>React SPA + Chat Widget<br/>OAuth 2.0 Authentication"]
  ma["ğŸ‘¥ Marketing Staff<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Analytics Dashboard<br/>Entra ID SSO + MFA"]
  dev["ğŸ’» Developer<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>VS Code + Copilot<br/>Git Workflow"]
end

%% --- LAYER 2: API GATEWAY & SECURITY ---
subgraph L2["ğŸ”’ Layer 2: API Gateway & Security"]
  direction TB
  apim["ğŸŒ Azure API Management<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ Rate Limiting: 100 req/min<br/>â€¢ OAuth 2.0 + JWT Validation<br/>â€¢ WAF + DDoS Protection<br/>â€¢ Request/Response Transform"]
  entra["ğŸ” Microsoft Entra ID<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ Single Sign-On SSO<br/>â€¢ Multi-Factor Auth MFA<br/>â€¢ RBAC + Conditional Access"]
  policy["âš–ï¸ Policy Engine<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>âœ“ PII Masking<br/>âœ“ Discount Validation â‰¤30%<br/>âœ“ Safety Filters<br/>âœ“ Compliance GDPR/CCPA"]
  kv["ğŸ”‘ Azure Key Vault<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Secrets & Certificates<br/>Managed Identity Access"]
end

%% --- LAYER 3: ORCHESTRATION ---
subgraph L3["ğŸ¯ Layer 3: Orchestration & Workflow"]
  direction TB
  orch["ğŸ§  Orchestrator Service<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ Intent Classification<br/>â€¢ Prompt Engineering<br/>â€¢ Context Grounding<br/>â€¢ Response Assembly"]
  agentmgr["ğŸ“‹ Agent Manager<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ Agent Registry<br/>â€¢ Load Balancing<br/>â€¢ Health Monitoring<br/>â€¢ Auto-Scaling 2-10 replicas"]
  fallback["ğŸ†˜ Fallback & Escalation<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ Low Confidence < 0.6<br/>â€¢ Sensitive Topics<br/>â€¢ Human Handoff Queue"]
end

%% --- LAYER 4: AI AGENTS ---
subgraph L4["ğŸ¤– Layer 4: Intelligent Agents"]
  direction TB
  cda["ğŸ¨ Customer Design Agent<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ Product Recommendations<br/>â€¢ Design Assistance<br/>â€¢ RAG: Product Catalog<br/>â€¢ LLM: GPT-4 Reasoning"]
  maa["ğŸ“Š Marketing Analytics Agent<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ Campaign Performance<br/>â€¢ Customer Segmentation<br/>â€¢ Trend Analysis<br/>âš ï¸ MASKED DATA ONLY"]
  doa["ğŸ”§ DevOps Agent<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ Copilot Integration<br/>â€¢ IaC Generation<br/>â€¢ PR Automation<br/>â€¢ Build Assistance"]
end

%% --- LAYER 5: AI FOUNDATION ---
subgraph L5["ğŸ§ª Layer 5: Model & Retrieval Services"]
  direction TB
  foundry["ğŸ­ Azure AI Foundry<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ Model Registry<br/>â€¢ Model Evaluation<br/>â€¢ A/B Testing<br/>â€¢ Governance & Approval"]
  openai["ğŸ§  Azure OpenAI Service<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ GPT-4 120K TPM<br/>â€¢ GPT-3.5-Turbo Fallback<br/>â€¢ Text Embeddings<br/>â€¢ Content Filtering"]
  aisearch["ğŸ” Azure AI Search<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ Product Catalog Index<br/>â€¢ Hybrid Search Keyword+Semantic<br/>â€¢ Vector Embeddings 1536-dim<br/>â€¢ Latency < 100ms p95"]
end

%% --- LAYER 6: DATA LAYER ---
subgraph L6["ğŸ’¾ Layer 6: Data & Storage"]
  direction TB
  fabric["ğŸ¢ Microsoft Fabric Lakehouse<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>ğŸ”’ READ-ONLY ACCESS<br/>âœ“ Aggregated Data MIN 10 rows<br/>âœ“ PII Masked via Policy Engine<br/>âŒ NO Raw Customer Data"]
  pdb["ğŸ“¦ Product Database<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Azure SQL / Cosmos DB<br/>Product Catalog Source<br/>Nightly Sync â†’ AI Search"]
end

%% --- LAYER 7: DEVOPS & OBSERVABILITY ---
subgraph L7["ğŸš€ Layer 7: DevOps & Operations"]
  direction TB
  ghe["ğŸ“ GitHub Enterprise<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Source Code Repos<br/>Branch Protection<br/>Code Review Workflow"]
  ghcopilot["ğŸ¤– GitHub Copilot<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>AI Code Completion<br/>Test Generation<br/>Documentation"]
  gha["âš™ï¸ GitHub Actions<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>CI/CD Pipelines<br/>Security Scanning<br/>Auto-Deploy"]
  host["â˜¸ï¸ Deployment Host<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Azure Kubernetes Service<br/>Auto-Scaling Enabled<br/>Private Endpoints"]
  monitor["ğŸ“ˆ Azure Monitor<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Log Analytics Workspace<br/>Application Insights<br/>Alerts & Dashboards"]
end

%% ============================================================================
%% DATA FLOWS - PRIMARY REQUEST PATHS
%% ============================================================================

%% User to API Gateway
cu -->|"HTTPS/TLS 1.3"| apim
ma -->|"HTTPS/TLS 1.3"| apim
dev -->|"Git Push"| ghe

%% API Gateway â†’ Security
apim -->|"1. Authenticate"| entra
entra -->|"2. Token Valid"| apim
apim -->|"3. Security Check"| policy

%% Policy to Orchestration
policy -->|"4. Validated Request"| orch

%% Orchestration Flow
orch -->|"5a. Route to Agent"| agentmgr
orch -->|"5b. Model Governance"| foundry

%% Agent Manager Distribution
agentmgr -->|"6. Design Intent"| cda
agentmgr -->|"6. Analytics Intent"| maa
agentmgr -->|"6. DevOps Intent"| doa
agentmgr -.->|"Low Confidence"| fallback

%% Fallback Escalation
fallback -.->|"Human Handoff"| ma

%% AI Foundry Governance
foundry -->|"Model Selection & Policy"| openai

%% Customer Design Agent Flow
cda -->|"LLM Reasoning"| openai
cda -->|"RAG: Product Search"| aisearch
cda -.->|"Response Assembly"| orch

%% Marketing Analytics Agent Flow - CRITICAL DATA CONTROLS
maa -->|"âš ï¸ AGGREGATED QUERY ONLY"| fabric
maa -->|"Insight Generation"| openai
fabric -.->|"Masked Results"| policy
maa -.->|"Response Assembly"| orch

%% DevOps Agent Flow
doa -->|"Code Suggestions"| ghcopilot
doa -->|"PR Creation"| gha
doa -.->|"Repository Access"| ghe

%% Data Layer Connections
aisearch -->|"Index Source"| pdb
pdb -.->|"Nightly ETL"| aisearch

%% DevOps Pipeline
ghe -->|"Trigger Build"| gha
gha -->|"Deploy Container"| host

%% Key Vault Integration
kv -.->|"Secrets: OpenAI Keys"| orch
kv -.->|"Secrets: DB Conn"| fabric
kv -.->|"Secrets: API Keys"| apim

%% ============================================================================
%% OBSERVABILITY - ALL LAYERS TO MONITORING
%% ============================================================================

apim -.->|"API Metrics"| monitor
policy -.->|"Policy Decisions"| monitor
orch -.->|"Orchestration Metrics"| monitor
agentmgr -.->|"Agent Performance"| monitor
cda -.->|"Agent Telemetry"| monitor
maa -.->|"Data Access Audit"| monitor
doa -.->|"DevOps Metrics"| monitor
openai -.->|"Token Usage"| monitor
fabric -.->|"Query Audit"| monitor
gha -.->|"Build Metrics"| monitor
host -.->|"Infrastructure Metrics"| monitor

%% ============================================================================
%% VISUAL STYLING
%% ============================================================================

classDef userLayer fill:#e3f2fd,stroke:#1976d2,stroke-width:3px,color:#000;
classDef securityLayer fill:#fce4ec,stroke:#c2185b,stroke-width:3px,color:#000;
classDef orchLayer fill:#e8f5e9,stroke:#388e3c,stroke-width:3px,color:#000;
classDef agentLayer fill:#fff3e0,stroke:#f57c00,stroke-width:3px,color:#000;
classDef aiLayer fill:#f3e5f5,stroke:#7b1fa2,stroke-width:3px,color:#000;
classDef dataLayer fill:#e0f2f1,stroke:#00695c,stroke-width:3px,color:#000;
classDef devopsLayer fill:#e1f5fe,stroke:#0277bd,stroke-width:3px,color:#000;

classDef criticalComponent fill:#ffebee,stroke:#c62828,stroke-width:4px,color:#000,stroke-dasharray: 5 5;

class L1 userLayer;
class L2 securityLayer;
class L3 orchLayer;
class L4 agentLayer;
class L5 aiLayer;
class L6 dataLayer;
class L7 devopsLayer;

class policy,fabric criticalComponent;