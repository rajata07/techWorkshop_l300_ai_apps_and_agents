flowchart TD
%% --- LAYER 1: USERS ---
subgraph L1["Layer 1: Users"]
  direction LR
  cu[Customer<br/>Web App]
  ma[Marketing Staff]
  dev[Developer]
end

%% --- LAYER 2: API & Security ---
subgraph L2["Layer 2: API & Security"]
  direction LR
  apim[Azure API Management]
  entra[Microsoft Entra ID]
  policy[Policy Engine<br/>Masking, Discount Validator, Safety Checks]
  kv[Azure Key Vault]
end

%% --- LAYER 3: Orchestration ---
subgraph L3["Layer 3: Orchestration"]
  direction LR
  orch[Orchestrator Service<br/>Intent Prompt Routing Grounding]
  agentmgr[Agent Manager]
  fallback[Fallback<br/>Human Escalation]
end

%% --- LAYER 4: Agents ---
subgraph L4["Layer 4: Agents"]
  direction LR
  cda[Customer Design Agent]
  maa[Marketing Analytics Agent]
  doa[DevOps Agent<br/>Copilot Assistant]
end

%% --- LAYER 5: Model & Retrieval ---
subgraph L5["Layer 5: Model & Retrieval"]
  direction LR
  openai[Azure OpenAI<br/>LLM]
  foundry[Azure AI Foundry<br/>Model Registry & Governance]
  aisearch[Azure AI Search<br/>Product Catalog]
end

%% --- LAYER 6: Data ---
subgraph L6["Layer 6: Data"]
  direction LR
  fabric[Microsoft Fabric Lakehouse<br/>Read-only Masked Aggregated]
  pdb[Product DB<br/>Catalog Index]
end

%% --- LAYER 7: DevOps & Ops ---
subgraph L7["Layer 7: DevOps & Ops"]
  direction LR
  ghe[GitHub Enterprise]
  gha[GitHub Actions]
  copilot[GitHub Copilot]
  host[AKS App Services VMs]
  monitor[Azure Monitor<br/>Log Analytics]
end

%% --- FLOW: USERS â†’ API & SECURITY
cu --> apim
ma --> apim
dev --> ghe

%% --- FLOW: API & SECURITY LAYER ---
apim --> entra
entra --> policy
policy --> orch

%% --- Orchestration Layer ---
orch --> agentmgr
agentmgr --> cda
agentmgr --> maa
agentmgr --> doa
agentmgr --> fallback

fallback -.-> ma

%% --- Orchestrator to AI Foundry for model governance
orch -- "Model registration evaluation" --> foundry
foundry -- "Model registry governance" --> openai

%% --- AGENTS LAYER CONNECTIVITY ---
cda -- "LLM Reasoning" --> openai
cda -- "Product Lookup RAG" --> aisearch
maa -- "masked aggregated data only" --> fabric
doa -- "Actions PRs" --> gha
doa -- "DevOps Assist" --- ghe
doa -- "Copilot Suggestions" --- copilot

aisearch -- "Index Data Source" --> pdb
fabric -.-> maa

%% --- MODEL & RETRIEVAL TO ORCHESTRATION where necessary ---
cda -- "Prompt Assembly RAG" --> orch
maa -- "Prompt Assembly" --> orch

%% --- DEVOPS LAYER CONNECTIVITY
ghe --> gha
gha --> host
host --> monitor

%% --- OBSERVABILITY LAYER (logs, metrics, audit) ---
policy -- "logs metrics audit" --> monitor
orch -- "logs metrics audit" --> monitor
agentmgr -- "logs metrics audit" --> monitor
cda -- "logs metrics audit" --> monitor
maa -- "logs metrics audit" --> monitor
doa -- "logs metrics audit" --> monitor
fabric -- "logs metrics audit" --> monitor
gha -- "logs metrics audit" --> monitor
host -- "logs metrics audit" --> monitor

%% --- STYLE FOR VISIBILITY ---
classDef layer fill:#f8fafd,stroke:#aecef7,stroke-width:2px;
classDef security fill:#f6eaf4,stroke:#ce5191,stroke-width:2px;
classDef orch fill:#e9fbe4,stroke:#4cb14c,stroke-width:2px;
classDef agent fill:#fffbe7,stroke:#f7a031,stroke-width:2px;
classDef data fill:#edeffa,stroke:#666fd7,stroke-width:2px;
classDef devops fill:#e8f9fd,stroke:#00b4d8,stroke-width:2px;

class L1,L2 layer
class policy security
class L3 orch
class L4 agent
class L5,L6 data
class L7 devops